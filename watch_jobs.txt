<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Watch Jobs Organizer</title>
  <!-- allow more pinch-zoom -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=20.0, user-scalable=yes" />
  <style>
    html,body { height:100%; margin:0; padding:0; font-family: Arial, sans-serif; background:#f5f5f5; }
    h1 { text-align:center; margin:10px 0; font-size:1.2rem; }
    .controls { display:flex; gap:8px; align-items:center; padding:0 12px 12px; flex-wrap:wrap; }
    button { padding:7px 10px; font-size:0.95rem; cursor:pointer; }
    .small { padding:6px 8px; font-size:0.85rem; }

    /* Whole canvas: scroll & zoom together */
    .board {
      display:flex;
      flex-direction:column;
      gap:30px;
      padding:12px;
      width: max-content;
      min-width: 100%;
      box-sizing: border-box;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }

    /* Category container (fixed in place) */
    .category {
      display:flex;
      flex-direction:column;
      background:#fff;
      border:1px solid #ccc;
      border-radius:6px;
      padding:12px;
      box-sizing:border-box;
      min-width: 900px;
      max-width: 1600px;
    }

    /* left aligned title placed above date area */
    .category h2 {
      margin:0 0 10px 6px;
      text-align:left;
      font-size:1rem;
      user-select:none;
      pointer-events:none;
    }

    /* Job cards - compact */
    .job {
      display:flex;
      align-items:center;
      gap:1px;                /* gap between fields */
      margin:3px 0;           /* vertical gap between jobs */
      padding:3px;            /* inner padding */
      background:#e6f3ff;
      border:1px solid #b3d1ff;
      border-radius:6px;
      box-shadow:1px 1px 5px rgba(0,0,0,0.12);
      cursor:grab;
      white-space:nowrap;
      box-sizing:border-box;
      width:100%;
      min-width:900px;
      flex-shrink:0;
      -webkit-user-drag:none;
    }

    /* drag handle */
    .drag-handle {
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:28px;
      height:28px;
      border-radius:4px;
      background:transparent;
      color:#333;
      font-weight:bold;
      cursor:grab;
      flex-shrink:0;
      user-select:none;
    }

    .job input[type="text"], .job input[type="date"], .job select {
      padding:4px 6px;
      font-size:0.9rem;
      box-sizing:border-box;
      min-height:30px;
      border-radius:4px;
      border:1px solid rgba(0,0,0,0.12);
      background:white;
    }

    .job .notes { width:220px; }
    .job .price { width:110px; }
    .job .reference { width:120px; }
    .job .customer { width:160px; }
    .job .brand { width:170px; }
    .job .client { width:140px; }
    .job .date { width:130px; }
    .job .work { width:220px; }

    .work-display {
      font-size:0.85rem;
      font-weight:700;
      color:#222;
      margin-left:6px;
      max-width:260px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .delete-btn { color:#c00; cursor:pointer; padding:4px; flex-shrink:0; user-select:none; }

    /* small screens tweak but keep single-line layout */
    @media (max-width:520px) {
      .category { min-width:700px; }
      .job { min-width:700px; }
      .job .brand, .job .work { width:140px; }
    }
  </style>
</head>
<body>
  <h1>Watch Jobs Organizer</h1>

  <div class="controls">
    <button id="addBtn">+ Add Job</button>
    <button id="resetBtn" class="small" title="Clear all saved jobs on this device">Reset saved data</button>

    <!-- Manage brands/clients -->
    <button id="manageBrandsBtn" class="small">Manage Brands</button>
    <button id="manageClientsBtn" class="small">Manage Clients</button>

    <div id="jobCount" style="margin-left:8px; font-size:0.95rem; color:#333;">Active Jobs: 0</div>
    <div style="margin-left:auto; font-size:0.9rem; color:#666;">Data saved locally on this device</div>
  </div>

  <div class="board" id="board" tabindex="0"></div>

  <!-- SortableJS for drag & drop -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js"></script>
  <script>
    // --- Keys and defaults ---
    const STORAGE_KEY = 'watchJobs_v2';
    const BRANDS_KEY = 'watchBrands_v2';
    const CLIENTS_KEY = 'watchClients_v2';

    const DEFAULT_CATEGORIES = ["Received","For Polishing","In Polishing","Waiting Parts","Ready For Service","Testing","Sent"];
    const DEFAULT_BRANDS = ["Rolex","Omega","Patek Philippe","Audemars Piguet","Jaeger-LeCoultre","TAG Heuer","Breitling","IWC","Cartier","Longines"];
    const DEFAULT_CLIENTS = []; // start empty per request
    const DEFAULT_WORKS = ["Service","Polish","Crystal","Parts","Dial Restore","Crown repair","Partial Job"];

    const board = document.getElementById('board');
    const addBtn = document.getElementById('addBtn');
    const resetBtn = document.getElementById('resetBtn');
    const manageBrandsBtn = document.getElementById('manageBrandsBtn');
    const manageClientsBtn = document.getElementById('manageClientsBtn');
    const jobCountEl = document.getElementById('jobCount');

    // load lists from storage or defaults
    function loadList(key, defaults) {
      try {
        const raw = localStorage.getItem(key);
        if (!raw) return defaults.slice();
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) return defaults.slice();
        return parsed;
      } catch { return defaults.slice(); }
    }

    function saveList(key, arr) {
      localStorage.setItem(key, JSON.stringify(arr));
    }

    let brands = loadList(BRANDS_KEY, DEFAULT_BRANDS);
    let clients = loadList(CLIENTS_KEY, DEFAULT_CLIENTS);
    const works = DEFAULT_WORKS.slice();

    // utilities
    function uid() { return 'j-' + Math.random().toString(36).slice(2,10); }

    // Build categories and attach Sortable (jobs draggable only via handle)
    function buildBoard() {
      board.innerHTML = '';
      DEFAULT_CATEGORIES.forEach(catName => {
        const cat = document.createElement('div');
        cat.className = 'category';
        cat.id = catName;
        const title = document.createElement('h2');
        title.textContent = catName;
        cat.appendChild(title);
        board.appendChild(cat);

        Sortable.create(cat, {
          group: 'jobs',
          animation: 150,
          draggable: '.job',     // only job elements draggable
          handle: '.drag-handle',// start drag from handle
          onAdd: saveJobs,
          onUpdate: saveJobs,
          onRemove: saveJobs
        });
      });
    }

    // Build datalist elements (for existing inputs to reference)
    function createDatalists() {
      // remove existing if any
      document.querySelectorAll('#brandList,#clientList').forEach(n => n.remove());

      const dBrand = document.createElement('datalist');
      dBrand.id = 'brandList';
      brands.forEach(b => {
        const o = document.createElement('option'); o.value = b; dBrand.appendChild(o);
      });
      document.body.appendChild(dBrand);

      const dClient = document.createElement('datalist');
      dClient.id = 'clientList';
      clients.forEach(c => {
        const o = document.createElement('option'); o.value = c; dClient.appendChild(o);
      });
      document.body.appendChild(dClient);
    }

    // create a job DOM element from data
    function createJobElement(data = {}) {
      const job = document.createElement('div');
      job.className = 'job';
      job.dataset.id = data.id || uid();

      // drag handle
      const handle = document.createElement('div');
      handle.className = 'drag-handle';
      handle.title = 'Drag job';
      handle.textContent = '≡';

      // date (editable)
      const date = document.createElement('input');
      date.type = 'date';
      date.className = 'date';
      date.value = data.date || new Date().toISOString().split('T')[0];
      date.addEventListener('change', saveJobs);

      // client (editable with datalist)
      const client = document.createElement('input');
      client.className = 'client';
      client.type = 'text';
      client.setAttribute('list','clientList');
      client.placeholder = 'Client';
      client.value = data.client || '';
      client.addEventListener('change', () => {
        // if typed a new non-empty client, optionally add to list? we keep manage button to control list
        saveJobs();
      });

      // brand (editable with datalist)
      const brand = document.createElement('input');
      brand.className = 'brand';
      brand.type = 'text';
      brand.setAttribute('list','brandList');
      brand.placeholder = 'Brand';
      brand.value = data.brand || '';
      brand.addEventListener('change', saveJobs);

      // reference
      const reference = document.createElement('input');
      reference.className = 'reference';
      reference.type = 'text';
      reference.maxLength = 10;
      reference.placeholder = 'Reference';
      reference.value = data.reference || '';
      reference.addEventListener('input', saveJobs);

      // customer
      const customer = document.createElement('input');
      customer.className = 'customer';
      customer.type = 'text';
      customer.placeholder = 'Customer Name';
      customer.value = data.customer || '';
      customer.addEventListener('input', saveJobs);

      // work multi-select
      const work = document.createElement('select');
      work.className = 'work';
      work.multiple = true;
      works.forEach(w => {
        const opt = new Option(w,w);
        if (data.work && data.work.includes(w)) opt.selected = true;
        work.add(opt);
      });
      work.addEventListener('change', () => {
        updateWorkDisplay(job);
        saveJobs();
      });

      // visible work display
      const workDisplay = document.createElement('div');
      workDisplay.className = 'work-display';
      // set initial text
      workDisplay.textContent = (data.work && data.work.length) ? data.work.join(', ') : '';

      // price input with £ prefix
      const price = document.createElement('input');
      price.className = 'price';
      price.type = 'text';
      price.placeholder = '£0.00';
      price.value = data.price || '';
      price.addEventListener('input', () => {
        let val = price.value.replace(/[^0-9.]/g,'');
        const parts = val.split('.');
        if (parts.length>2) { val = parts.shift() + '.' + parts.join(''); }
        if (val !== '') price.value = '£' + val;
        else price.value = '';
        saveJobs();
      });

      // notes
      const notes = document.createElement('input');
      notes.className = 'notes';
      notes.type = 'text';
      notes.placeholder = 'Notes';
      notes.value = data.notes || '';
      notes.addEventListener('input', saveJobs);

      // delete
      const del = document.createElement('span');
      del.className = 'delete-btn';
      del.title = 'Delete job';
      del.textContent = '✖';
      del.addEventListener('click', () => {
        if (!confirm('Delete this job?')) return;
        job.remove();
        saveJobs();
      });

      // assemble in order: handle, date, client, brand, reference, customer, work, workDisplay, price, notes, delete
      job.append(handle, date, client, brand, reference, customer, work, workDisplay, price, notes, del);

      return job;
    }

    // update visible work display for a given job element
    function updateWorkDisplay(job) {
      const work = job.querySelector('.work');
      const display = job.querySelector('.work-display');
      if (!work || !display) return;
      const selected = Array.from(work.selectedOptions).map(o => o.value);
      display.textContent = selected.join(', ');
    }

    // Save all jobs (and their current fields) into localStorage
    function saveJobs() {
      const data = {};
      DEFAULT_CATEGORIES.forEach(cat => {
        const container = document.getElementById(cat);
        data[cat] = [];
        if (!container) return;
        container.querySelectorAll('.job').forEach(job => {
          data[cat].push({
            id: job.dataset.id,
            date: job.querySelector('.date').value,
            client: job.querySelector('.client').value,
            brand: job.querySelector('.brand').value,
            reference: job.querySelector('.reference').value,
            customer: job.querySelector('.customer').value,
            work: Array.from(job.querySelector('.work').selectedOptions).map(o => o.value),
            price: job.querySelector('.price').value,
            notes: job.querySelector('.notes').value
          });
        });
      });
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      updateJobCount();
    }

    // load saved jobs and lists
    function loadAll() {
      // datalists first
      createDatalists();

      // build categories
      buildBoard();

      // load jobs
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) { updateJobCount(); return; }
        const parsed = JSON.parse(raw);
        DEFAULT_CATEGORIES.forEach(cat => {
          const list = parsed[cat] || [];
          const container = document.getElementById(cat);
          list.forEach(jobData => {
            const jobEl = createJobElement(jobData);
            // preserve id if exists
            if (jobData.id) jobEl.dataset.id = jobData.id;
            container.appendChild(jobEl);
            updateWorkDisplay(jobEl);
          });
        });
      } catch (e) {
        console.error('Failed to parse saved jobs', e);
      }
      updateJobCount();
    }

    // add job to Received by default
    function addJob(defaultCat = 'Received', data = {}) {
      const container = document.getElementById(defaultCat);
      if (!container) return;
      const jobEl = createJobElement(data);
      container.appendChild(jobEl);
      // ensure datalist exists for new inputs
      createDatalists();
      saveJobs();
      // scroll to new job
      setTimeout(()=>jobEl.scrollIntoView({behavior:'smooth', block:'center', inline:'nearest'}), 120);
      return jobEl;
    }

    // update job count excluding Sent
    function updateJobCount() {
      const total = document.querySelectorAll('.job').length;
      const sent = document.querySelectorAll('#Sent .job').length;
      const active = total - sent;
      jobCountEl.textContent = 'Active Jobs: ' + active;
    }

    // --------- Management for brands & clients ----------
    function manageBrands() {
      const current = brands.join(', ');
      const input = prompt('Edit brands (comma separated). Existing brands will be replaced:', current);
      if (input === null) return;
      const arr = input.split(',').map(s => s.trim()).filter(Boolean);
      brands = Array.from(new Set(arr)); // unique
      saveList(BRANDS_KEY, brands);
      createDatalists();
      // update existing brand inputs to keep options (do not overwrite typed values)
      saveJobs();
    }

    function manageClients() {
      const current = clients.join(', ');
      const input = prompt('Edit clients (comma separated). Existing clients will be replaced:', current);
      if (input === null) return;
      const arr = input.split(',').map(s => s.trim()).filter(Boolean);
      clients = Array.from(new Set(arr));
      saveList(CLIENTS_KEY, clients);
      createDatalists();
      saveJobs();
    }

    // helper to create datalists
    function createDatalists() {
      // remove existing
      document.querySelectorAll('#brandList,#clientList').forEach(n => n.remove());
      // brand datalist
      const dB = document.createElement('datalist'); dB.id = 'brandList';
      brands.forEach(b => { const o = document.createElement('option'); o.value = b; dB.appendChild(o); });
      document.body.appendChild(dB);
      // client datalist
      const dC = document.createElement('datalist'); dC.id = 'clientList';
      clients.forEach(c => { const o = document.createElement('option'); o.value = c; dC.appendChild(o); });
      document.body.appendChild(dC);
    }

    // Reset saved data
    resetBtn.addEventListener('click', () => {
      if (!confirm('This will clear all saved jobs from this device. Continue?')) return;
      localStorage.removeItem(STORAGE_KEY);
      // keep brands/clients but optionally could clear
      buildBoard();
      updateJobCount();
      alert('Saved jobs cleared.');
    });

    // Manage buttons
    manageBrandsBtn.addEventListener('click', manageBrands);
    manageClientsBtn.addEventListener('click', manageClients);

    // Add job button
    addBtn.addEventListener('click', ()=> addJob('Received', {}));

    // keyboard pan support on board
    board.addEventListener('keydown', e => {
      const step = 100;
      if (e.key === 'ArrowLeft') board.scrollLeft -= step;
      if (e.key === 'ArrowRight') board.scrollLeft += step;
      if (e.key === 'ArrowUp') board.scrollTop -= step;
      if (e.key === 'ArrowDown') board.scrollTop += step;
    });

    // Auto-save periodically (safety)
    setInterval(saveJobs, 4000);

    // Initial load
    // ensure clients list persisted loaded
    clients = loadList(CLIENTS_KEY, DEFAULT_CLIENTS);
    brands = loadList(BRANDS_KEY, DEFAULT_BRANDS);
    createDatalists();
    loadAll();
  </script>
</body>
</html>